<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>上证指数收盘价与间隔天数分析</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 15px;
        }
        .header h1 {
            color: #333;
            margin: 0;
            font-size: 24px;
        }
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        label {
            font-weight: bold;
            color: #555;
            font-size: 14px;
        }
        input[type="date"], select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            padding: 8px 16px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #40a9ff;
        }
        #chart {
            width: 100%;
            height: 600px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
            border-left: 4px solid #1890ff;
        }
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #1890ff;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>上证指数收盘价与间隔天数分析</h1>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>开始日期：</label>
                <input type="date" id="startDate" value="2004-09-13">
            </div>
            <div class="control-group">
                <label>结束日期：</label>
                <input type="date" id="endDate" value="2024-12-20">
            </div>
            <div class="control-group">
                <label>图表类型：</label>
                <select id="chartType">
                    <option value="line">折线图</option>
                    <option value="bar">柱状图</option>
                    <option value="scatter">散点图</option>
                </select>
            </div>
            <button onclick="updateChart()">更新图表</button>
            <button onclick="resetZoom()">重置缩放</button>
        </div>
        
        <div id="chart"></div>
        
        <div class="stats">
            <div style="display: flex; gap: 20px; margin: 20px 0; flex-wrap: wrap;">
                <div class="stat-card">
                    <div class="stat-value" id="totalPoints">-</div>
                    <div class="stat-label">总记录数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="minPoint">-</div>
                    <div class="stat-label">最低收盘价</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="maxPoint">-</div>
                    <div class="stat-label">最高收盘价</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgDays">-</div>
                    <div class="stat-label">平均间隔天数</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chart;
        let allData = [];

        // 初始化图表
        function initChart() {
            chart = echarts.init(document.getElementById('chart'));
            loadData();
        }

        // 加载CSV数据
        async function loadData() {
            try {
                const response = await fetch('上证指数不重复点数序列.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                
                // 解析CSV数据 - 正确处理中文编码和格式
                const lines = csvText.trim().split('\n');
                allData = [];
                
                // 跳过标题行，从第2行开始
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        // 处理可能的中文逗号或引号
                        const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                        if (values.length >= 5) {
                            allData.push({
                                序号: parseInt(values[0]) || 0,
                                日期: values[1] || '',
                                收盘价: parseFloat(values[2]) || 0,
                                点数: parseInt(values[3]) || 0,
                                距上次天数: parseInt(values[4]) || 0
                            });
                        }
                    }
                }

                // 验证数据
                console.log('成功加载数据条数:', allData.length);
                if (allData.length > 0) {
                    console.log('第一条数据:', allData[0]);
                    console.log('最后一条数据:', allData[allData.length - 1]);
                }

                // 设置日期控件的范围
                if (allData.length > 0) {
                    const dates = allData.map(d => d.日期);
                    document.getElementById('startDate').value = dates[0];
                    document.getElementById('endDate').value = dates[dates.length - 1];
                }

                updateChart();
            } catch (error) {
                console.error('加载数据失败:', error);
                alert('加载CSV文件失败，请确保文件存在且可访问。错误信息: ' + error.message);
                
                // 使用实际数据作为后备
                allData = [
                    {序号: 1, 日期: '2004-09-13', 收盘价: 1260.32, 点数: 12, 距上次天数: 0},
                    {序号: 2, 日期: '2004-09-14', 收盘价: 1300.36, 点数: 13, 距上次天数: 1},
                    {序号: 3, 日期: '2004-09-17', 收盘价: 1414.7, 点数: 14, 距上次天数: 3},
                    {序号: 4, 日期: '2004-09-30', 收盘价: 1396.7, 点数: 13, 距上次天数: 13},
                    {序号: 5, 日期: '2004-10-08', 收盘价: 1422.93, 点数: 14, 距上次天数: 8},
                    {序号: 6, 日期: '2004-10-12', 收盘价: 1384.44, 点数: 13, 距上次天数: 4},
                    {序号: 7, 日期: '2004-12-17', 收盘价: 1290.49, 点数: 12, 距上次天数: 66}
                ];
                
                document.getElementById('startDate').value = '2004-09-13';
                document.getElementById('endDate').value = '2004-12-17';
                updateChart();
            }
        }

        // 更新统计信息
        function updateStats(filteredData) {
            if (filteredData.length === 0) {
                document.getElementById('totalPoints').textContent = '0';
                document.getElementById('minPoint').textContent = '0';
                document.getElementById('maxPoint').textContent = '0';
                document.getElementById('avgDays').textContent = '0';
                return;
            }

            const prices = filteredData.map(d => d.收盘价);
            const days = filteredData.map(d => d.距上次天数).filter(d => d > 0);
            
            document.getElementById('totalPoints').textContent = filteredData.length;
            document.getElementById('minPoint').textContent = Math.min(...prices).toFixed(2);
            document.getElementById('maxPoint').textContent = Math.max(...prices).toFixed(2);
            document.getElementById('avgDays').textContent = 
                days.length > 0 ? (days.reduce((a, b) => a + b, 0) / days.length).toFixed(1) : '0';
        }

        // 更新图表
        function updateChart() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const chartType = document.getElementById('chartType').value;
            
            // 过滤数据
            const filteredData = allData.filter(d => {
                return d.日期 >= startDate && d.日期 <= endDate;
            });
            
            // 按日期排序
            filteredData.sort((a, b) => new Date(a.日期) - new Date(b.日期));
            
            // 准备图表数据
            const dates = filteredData.map(d => d.日期);
            const prices = filteredData.map(d => d.收盘价);
            const intervals = filteredData.map(d => d.距上次天数);
            
            // 更新统计信息
            updateStats(filteredData);
            
            // 配置图表选项
            const option = {
                title: {
                    text: '上证指数收盘价与间隔天数分析',
                    subtext: `数据范围: ${startDate} 至 ${endDate} (共${filteredData.length}条记录)`,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        const dataIndex = params[0].dataIndex;
                        const data = filteredData[dataIndex];
                        return `日期: ${data.日期}<br/>
                                收盘价: ${data.收盘价.toFixed(2)}<br/>
                                距上次天数: ${data.距上次天数}天`;
                    }
                },
                axisPointer: {
                    type: 'cross',
                    crossStyle: {
                        color: '#ff4d4f',
                        width: 2,
                        type: 'solid'
                    },
                    label: {
                        backgroundColor: '#ff4d4f'
                    }
                },
                legend: {
                    data: ['收盘价', '间隔天数'],
                    top: 40
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                toolbox: {
                    feature: {
                        dataZoom: {
                            yAxisIndex: 'none'
                        },
                        restore: {},
                        saveAsImage: {}
                    }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    },
                    {
                        start: 0,
                        end: 100
                    }
                ],
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLabel: {
                        rotate: 45
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: '收盘价',
                        position: 'left',
                        axisLine: {
                            lineStyle: {
                                color: '#5470c6'
                            }
                        },
                        axisLabel: {
                            formatter: '{value}'
                        }
                    },
                    {
                        type: 'value',
                        name: '间隔天数',
                        position: 'right',
                        axisLine: {
                            lineStyle: {
                                color: '#fac858'
                            }
                        },
                        axisLabel: {
                            formatter: '{value}'
                        }
                    }
                ],
                series: [
                    {
                        name: '收盘价',
                        type: chartType,
                        data: prices,
                        yAxisIndex: 0,
                        itemStyle: {
                            color: '#5470c6'
                        },
                        emphasis: {
                            focus: 'series',
                            itemStyle: {
                                color: '#ff4d4f',
                                borderColor: '#ff4d4f',
                                borderWidth: 3
                            }
                        },
                        markLine: {
                            silent: true,
                            symbol: 'none',
                            lineStyle: {
                                color: '#ff4d4f',
                                width: 2,
                                type: 'solid'
                            },
                            data: []
                        }
                    },
                    {
                        name: '间隔天数',
                        type: 'bar',
                        data: intervals,
                        yAxisIndex: 1,
                        itemStyle: {
                            color: '#fac858',
                            opacity: 0.7
                        },
                        emphasis: {
                            focus: 'series',
                            itemStyle: {
                                color: '#ff7875',
                                opacity: 1
                            }
                        }
                    }
                ]
            };
            
            chart.setOption(option);
            
            // 添加鼠标悬停事件，显示红色水平参考线
            chart.on('mouseover', {seriesIndex: 0}, function(params) {
                const priceValue = params.value;
                chart.setOption({
                    series: [{
                        markLine: {
                            data: [{
                                yAxis: priceValue,
                                lineStyle: {
                                    color: '#ff4d4f',
                                    width: 2,
                                    type: 'solid'
                                },
                                label: {
                                    show: true,
                                    formatter: '收盘价: ' + priceValue.toFixed(2),
                                    backgroundColor: '#ff4d4f',
                                    color: '#fff',
                                    padding: [3, 6],
                                    borderRadius: 3
                                }
                            }]
                        }
                    }]
                });
            });
            
            // 鼠标移出时移除标记线
            chart.on('mouseout', function() {
                chart.setOption({
                    series: [{
                        markLine: {
                            data: []
                        }
                    }]
                });
            });
            
            // 添加点击事件，高亮与红线相交的点
            chart.on('click', {seriesIndex: 0}, function(params) {
                const targetPrice = params.value;
                const tolerance = 5; // 5点的容差
                
                // 找出所有接近该价格的点
                const matchingIndices = [];
                filteredData.forEach((item, index) => {
                    if (Math.abs(item.收盘价 - targetPrice) <= tolerance) {
                        matchingIndices.push(index);
                    }
                });
                
                // 高亮这些点并显示红色参考线
                chart.setOption({
                    series: [{
                        markLine: {
                            data: [{
                                yAxis: targetPrice,
                                lineStyle: {
                                    color: '#ff4d4f',
                                    width: 3,
                                    type: 'solid'
                                },
                                label: {
                                    show: true,
                                    formatter: '参考线: ' + targetPrice.toFixed(2),
                                    backgroundColor: '#ff4d4f',
                                    color: '#fff'
                                }
                            }]
                        }
                    }]
                });
                
                // 高亮交叉点
                if (matchingIndices.length > 0) {
                    chart.dispatchAction({
                        type: 'highlight',
                        seriesIndex: 0,
                        dataIndex: matchingIndices
                    });
                }
            });
        }

        // 重置缩放
        function resetZoom() {
            chart.dispatchAction({
                type: 'dataZoom',
                start: 0,
                end: 100
            });
        }

        // 窗口大小改变时重新调整图表
        window.addEventListener('resize', function() {
            if (chart) {
                chart.resize();
            }
        });

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initChart);
    </script>
</body>
</html>