<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票分钟级交易数据分析</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 15px;
        }
        .header h1 {
            color: #333;
            margin: 0;
            font-size: 24px;
        }
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        label {
            font-weight: bold;
            color: #555;
            font-size: 14px;
        }
        input[type="date"], select, input[type="file"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            padding: 8px 16px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #40a9ff;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #chart {
            width: 100%;
            height: 600px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
            border-left: 4px solid #1890ff;
        }
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #1890ff;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .file-info {
            background: #e6f7ff;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #1890ff;
            font-size: 14px;
        }
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
            font-size: 16px;
        }
        .error {
            text-align: center;
            padding: 50px;
            color: #ff4d4f;
            font-size: 16px;
        }
        .data-source-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .debug-info {
            background: #fff3cd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #ffc107;
            font-size: 12px;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>股票分钟级交易数据分析</h1>
            <p class="data-source-info">支持CSV格式的分钟级股票数据，可自定义选择任意文件进行分析</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>选择文件：</label>
                <input type="file" id="fileInput" accept=".csv" onchange="handleFileSelect(event)">
            </div>
            <div class="control-group">
                <label>示例数据：</label>
                <select id="sampleSelect" onchange="loadSampleFile()">
                    <option value="">-- 选择示例 --</option>
                    <option value="603696_stockzhahistminem _20250823_130857.csv">603696海南矿业</option>
                    <option value="601288_stockzhahistminem _20250823_143255.csv">601288农业银行</option>
                </select>
            </div>
            <div class="control-group">
                <label>开始日期：</label>
                <input type="date" id="startDate" value="2025-08-18">
            </div>
            <div class="control-group">
                <label>结束日期：</label>
                <input type="date" id="endDate" value="2025-08-22">
            </div>
            <div class="control-group">
                <label>图表类型：</label>
                <select id="chartType">
                    <option value="candlestick">K线图</option>
                    <option value="line">分时图</option>
                    <option value="volume">成交量图</option>
                </select>
            </div>
            <div class="control-group">
                <label>时间范围：</label>
                <select id="timeRange">
                    <option value="all">全天</option>
                    <option value="morning">上午盘</option>
                    <option value="afternoon">下午盘</option>
                </select>
            </div>
            <button onclick="updateChart()" id="updateBtn" disabled>更新图表</button>
            <button onclick="resetZoom()">重置缩放</button>
            <button onclick="clearData()">清空数据</button>
        </div>
        
        <div id="fileInfo" class="file-info" style="display: none;">
            <strong>当前文件：</strong><span id="currentFileName">-</span><br>
            <strong>数据条数：</strong><span id="dataCount">0</span> 条<br>
            <strong>日期范围：</strong><span id="dateRange">-</span><br>
            <strong>数据预览：</strong><span id="dataPreview">-</span>
        </div>
        
        <div id="debugInfo" class="debug-info" style="display: none;">
            <strong>调试信息：</strong><span id="debugText">-</span>
        </div>
        
        <div id="loading" class="loading" style="display: none;">
            正在加载数据...
        </div>
        
        <div id="error" class="error" style="display: none;">
            加载失败，请检查文件格式是否正确
        </div>
        
        <div id="chart" style="display: none;"></div>
        
        <div class="stats" id="statsPanel" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="openPrice">-</div>
                <div class="stat-label">开盘价</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="closePrice">-</div>
                <div class="stat-label">收盘价</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="highPrice">-</div>
                <div class="stat-label">最高价</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="lowPrice">-</div>
                <div class="stat-label">最低价</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalVolume">-</div>
                <div class="stat-label">总成交量</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalAmount">-</div>
                <div class="stat-label">总成交额</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgPrice">-</div>
                <div class="stat-label">成交均价</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="changePercent">-</div>
                <div class="stat-label">涨跌幅</div>
            </div>
        </div>
    </div>

    <script>
        let chart;
        let allData = [];
        let currentFileName = '';

        // 初始化图表
        function initChart() {
            const chartDom = document.getElementById('chart');
            if (chartDom) {
                chart = echarts.init(chartDom);
                console.log('图表初始化成功');
            } else {
                console.error('图表容器未找到');
            }
        }

        // 显示调试信息
        function showDebug(message) {
            const debugDiv = document.getElementById('debugInfo');
            const debugText = document.getElementById('debugText');
            debugText.textContent = message;
            debugDiv.style.display = 'block';
            console.log('调试信息:', message);
        }

        // 处理文件选择
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                currentFileName = file.name;
                loadFileData(file);
            }
        }

        // 加载示例文件
        function loadSampleFile() {
            const select = document.getElementById('sampleSelect');
            const fileName = select.value;
            if (fileName) {
                currentFileName = fileName;
                loadDataFromUrl(fileName);
            }
        }

        // 从URL加载数据
        async function loadDataFromUrl(fileName) {
            showLoading();
            showDebug(`正在加载文件: ${fileName}`);
            try {
                const response = await fetch(fileName);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                showDebug(`文件加载成功，大小: ${csvText.length} 字符`);
                parseCSVData(csvText);
                hideLoading();
                showSuccess();
            } catch (error) {
                console.error('加载数据失败:', error);
                showError('加载文件失败: ' + error.message);
                loadMockData();
            }
        }

        // 加载本地文件数据
        function loadFileData(file) {
            showLoading();
            showDebug(`正在读取本地文件: ${file.name}`);
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    showDebug(`文件读取成功，大小: ${e.target.result.length} 字符`);
                    parseCSVData(e.target.result);
                    hideLoading();
                    showSuccess();
                } catch (error) {
                    console.error('解析数据失败:', error);
                    showError('文件格式错误，请检查CSV格式');
                    loadMockData();
                }
            };
            reader.onerror = function() {
                showError('文件读取失败');
            };
            reader.readAsText(file);
        }

        // 解析CSV数据
        function parseCSVData(csvText) {
            try {
                const lines = csvText.trim().split('\n');
                allData = [];
                
                showDebug(`总行数: ${lines.length}`);
                
                // 跳过标题行，从第2行开始
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                        if (values.length >= 8) {
                            const time = values[1];
                            const open = parseFloat(values[2]) || 0;
                            const close = parseFloat(values[3]) || 0;
                            const high = parseFloat(values[4]) || 0;
                            const low = parseFloat(values[5]) || 0;
                            const volume = parseInt(values[6]) || 0;
                            const amount = parseFloat(values[7]) || 0;
                            const avgPrice = parseFloat(values[8]) || 0;
                            
                            if (time && time.includes('-')) {
                                allData.push({
                                    time: time,
                                    date: time.split(' ')[0],
                                    open: open,
                                    close: close,
                                    high: high,
                                    low: low,
                                    volume: volume,
                                    amount: amount,
                                    avgPrice: avgPrice
                                });
                            }
                        }
                    }
                }

                showDebug(`成功解析数据条数: ${allData.length}`);
                
                if (allData.length === 0) {
                    showDebug('没有找到有效数据，使用模拟数据');
                    loadMockData();
                    return;
                }

                // 更新文件信息
                updateFileInfo();
                
                // 自动设置日期范围
                const dates = [...new Set(allData.map(d => d.date))].sort();
                if (dates.length > 0) {
                    document.getElementById('startDate').value = dates[0];
                    document.getElementById('endDate').value = dates[dates.length - 1];
                    showDebug(`日期范围: ${dates[0]} 至 ${dates[dates.length - 1]}`);
                }
                
                document.getElementById('updateBtn').disabled = false;
                updateChart();
            } catch (error) {
                console.error('解析CSV失败:', error);
                showError('CSV解析错误: ' + error.message);
                loadMockData();
            }
        }

        // 加载模拟数据
        function loadMockData() {
            showDebug('加载模拟数据...');
            const mockDates = ['2025-08-18', '2025-08-19', '2025-08-20', '2025-08-21', '2025-08-22'];
            allData = [];
            
            mockDates.forEach(date => {
                let basePrice = 10.79 + (Math.random() - 0.5) * 0.5;
                for (let hour = 9; hour <= 15; hour++) {
                    for (let minute = 0; minute < 60; minute += 5) {
                        if ((hour === 9 && minute >= 30) || (hour > 9 && hour < 15) || (hour === 15 && minute === 0)) {
                            const time = `${date} ${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}:00`;
                            const change = (Math.random() - 0.5) * 0.1;
                            basePrice += change;
                            
                            allData.push({
                                time: time,
                                date: date,
                                open: basePrice - Math.random() * 0.02,
                                close: basePrice + Math.random() * 0.02,
                                high: basePrice + Math.random() * 0.05,
                                low: basePrice - Math.random() * 0.05,
                                volume: Math.floor(Math.random() * 5000) + 1000,
                                amount: Math.floor(Math.random() * 500000) + 100000,
                                avgPrice: basePrice + Math.random() * 0.01
                            });
                        }
                    }
                }
            });
            
            showDebug(`模拟数据加载完成，共 ${allData.length} 条`);
            updateFileInfo();
            document.getElementById('updateBtn').disabled = false;
            updateChart();
        }

        // 更新文件信息
        function updateFileInfo() {
            const fileInfo = document.getElementById('fileInfo');
            const dataCount = document.getElementById('dataCount');
            const dateRange = document.getElementById('dateRange');
            const currentFileNameEl = document.getElementById('currentFileName');
            const dataPreview = document.getElementById('dataPreview');
            
            if (allData.length > 0) {
                const dates = [...new Set(allData.map(d => d.date))].sort();
                currentFileNameEl.textContent = currentFileName || '模拟数据';
                dataCount.textContent = allData.length.toLocaleString();
                dateRange.textContent = dates.length > 0 ? `${dates[0]} 至 ${dates[dates.length - 1]}` : '-';
                
                // 显示前几条数据预览
                const preview = allData.slice(0, 3).map(d => 
                    `${d.time.split(' ')[1]}: ${d.close.toFixed(2)}`
                ).join(', ');
                dataPreview.textContent = preview + '...';
                
                fileInfo.style.display = 'block';
            } else {
                fileInfo.style.display = 'none';
            }
        }

        // 显示/隐藏加载状态
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('chart').style.display = 'none';
            document.getElementById('statsPanel').style.display = 'none';
            document.getElementById('debugInfo').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        function showSuccess() {
            document.getElementById('error').style.display = 'none';
            document.getElementById('chart').style.display = 'block';
            document.getElementById('statsPanel').style.display = 'grid';
            document.getElementById('debugInfo').style.display = 'none';
        }

        // 检查日期是否在范围内
        function isDateInRange(dateStr, startDate, endDate) {
            try {
                const date = new Date(dateStr.split(' ')[0]);
                const start = new Date(startDate);
                const end = new Date(endDate);
                return date >= start && date <= end;
            } catch (error) {
                console.error('日期比较错误:', error);
                return true;
            }
        }

        // 更新统计信息
        function updateStats(data) {
            if (data.length === 0) {
                document.getElementById('openPrice').textContent = '0.00';
                document.getElementById('closePrice').textContent = '0.00';
                document.getElementById('highPrice').textContent = '0.00';
                document.getElementById('lowPrice').textContent = '0.00';
                document.getElementById('totalVolume').textContent = '0';
                document.getElementById('totalAmount').textContent = '0.00';
                document.getElementById('avgPrice').textContent = '0.00';
                document.getElementById('changePercent').textContent = '0.00%';
                return;
            }

            // 按日期分组
            const groupedByDate = {};
            data.forEach(item => {
                if (!groupedByDate[item.date]) {
                    groupedByDate[item.date] = [];
                }
                groupedByDate[item.date].push(item);
            });

            const dates = Object.keys(groupedByDate).sort();
            const firstDate = groupedByDate[dates[0]];
            const lastDate = groupedByDate[dates[dates.length - 1]];
            
            const firstPrice = firstDate[0].open;
            const lastPrice = lastDate[lastDate.length - 1].close;
            
            let highPrice = -Infinity;
            let lowPrice = Infinity;
            let totalVolume = 0;
            let totalAmount = 0;
            
            data.forEach(item => {
                highPrice = Math.max(highPrice, item.high);
                lowPrice = Math.min(lowPrice, item.low);
                totalVolume += item.volume;
                totalAmount += item.amount;
            });

            const avgPrice = totalVolume > 0 ? totalAmount / totalVolume : 0;
            const changePercent = firstPrice > 0 ? ((lastPrice - firstPrice) / firstPrice * 100) : 0;
            
            document.getElementById('openPrice').textContent = firstPrice.toFixed(2);
            document.getElementById('closePrice').textContent = lastPrice.toFixed(2);
            document.getElementById('highPrice').textContent = highPrice.toFixed(2);
            document.getElementById('lowPrice').textContent = lowPrice.toFixed(2);
            document.getElementById('totalVolume').textContent = totalVolume.toLocaleString();
            document.getElementById('totalAmount').textContent = (totalAmount / 10000).toFixed(2) + '万';
            document.getElementById('avgPrice').textContent = avgPrice.toFixed(2);
            document.getElementById('changePercent').textContent = changePercent.toFixed(2) + '%';
            
            // 设置颜色
            const changeElement = document.getElementById('changePercent');
            changeElement.style.color = changePercent >= 0 ? '#ff4d4f' : '#52c41a';
        }

        // 更新图表
        function updateChart() {
            if (allData.length === 0) {
                showDebug('没有数据可显示');
                return;
            }
            
            if (!chart) {
                showDebug('图表未初始化');
                initChart();
                return;
            }
            
            const chartType = document.getElementById('chartType').value;
            const timeRange = document.getElementById('timeRange').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            showDebug(`更新图表: ${chartType}, 日期范围: ${startDate} - ${endDate}, 时间范围: ${timeRange}`);
            
            // 过滤数据
            let filteredData = allData.filter(item => 
                isDateInRange(item.time, startDate, endDate)
            );
            
            if (timeRange === 'morning') {
                filteredData = filteredData.filter(d => {
                    const hour = parseInt(d.time.split(' ')[1].split(':')[0]);
                    return hour >= 9 && hour < 11;
                });
            } else if (timeRange === 'afternoon') {
                filteredData = filteredData.filter(d => {
                    const hour = parseInt(d.time.split(' ')[1].split(':')[0]);
                    return hour >= 13 && hour < 15;
                });
            }
            
            // 按时间排序
            filteredData.sort((a, b) => new Date(a.time) - new Date(b.time));
            
            showDebug(`过滤后数据条数: ${filteredData.length}`);
            
            if (filteredData.length === 0) {
                showError('当前选择条件下没有数据');
                return;
            }
            
            // 更新统计信息
            updateStats(filteredData);
            
            try {
                if (chartType === 'candlestick') {
                    drawCandlestickChart(filteredData);
                } else if (chartType === 'line') {
                    drawLineChart(filteredData);
                } else if (chartType === 'volume') {
                    drawVolumeChart(filteredData);
                }
                
                // 强制重绘
                chart.resize();
            } catch (error) {
                console.error('绘制图表错误:', error);
                showError('图表绘制失败: ' + error.message);
            }
        }

        // 绘制K线图
        function drawCandlestickChart(data) {
            try {
                const times = data.map(d => d.time.split(' ')[1] + '\n' + d.date);
                const candleData = data.map(d => [d.open, d.close, d.low, d.high]);
                const volumeData = data.map(d => d.volume);
                
                const option = {
                    title: {
                        text: `${currentFileName || '股票'} 分钟K线图 (${document.getElementById('startDate').value} - ${document.getElementById('endDate').value})`,
                        left: 'center',
                        textStyle: { fontSize: 16 }
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'cross' },
                        formatter: function(params) {
                            const dataIndex = params[0].dataIndex;
                            const item = data[dataIndex];
                            return `<div style="font-size: 12px;">
                                <strong>${item.date} ${item.time.split(' ')[1]}</strong><br/>
                                开盘: ${item.open.toFixed(2)}<br/>
                                收盘: ${item.close.toFixed(2)}<br/>
                                最高: ${item.high.toFixed(2)}<br/>
                                最低: ${item.low.toFixed(2)}<br/>
                                成交量: ${item.volume.toLocaleString()}<br/>
                                成交额: ${(item.amount/10000).toFixed(2)}万
                            </div>`;
                        }
                    },
                    legend: {
                        data: ['K线', '成交量'],
                        top: 35
                    },
                    grid: [
                        {
                            left: '3%',
                            right: '3%',
                            top: '15%',
                            height: '60%',
                            containLabel: true
                        },
                        {
                            left: '3%',
                            right: '3%',
                            top: '80%',
                            height: '15%',
                            containLabel: true
                        }
                    ],
                    xAxis: [
                        {
                            type: 'category',
                            data: times,
                            boundaryGap: false,
                            axisLabel: { 
                                rotate: 45,
                                interval: Math.max(1, Math.floor(times.length / 15))
                            }
                        },
                        {
                            type: 'category',
                            gridIndex: 1,
                            data: times,
                            axisLabel: { show: false }
                        }
                    ],
                    yAxis: [
                        {
                            name: '价格',
                            scale: true,
                            splitArea: { show: true }
                        },
                        {
                            name: '成交量',
                            scale: true,
                            gridIndex: 1,
                            splitNumber: 3
                        }
                    ],
                    dataZoom: [
                        {
                            type: 'inside',
                            xAxisIndex: [0, 1],
                            start: 0,
                            end: 100
                        },
                        {
                            show: true,
                            xAxisIndex: [0, 1],
                            type: 'slider',
                            top: '95%',
                            start: 0,
                            end: 100
                        }
                    ],
                    series: [
                        {
                            name: 'K线',
                            type: 'candlestick',
                            data: candleData,
                            itemStyle: {
                                color: '#ff4d4f',
                                color0: '#52c41a',
                                borderColor: '#ff4d4f',
                                borderColor0: '#52c41a'
                            }
                        },
                        {
                            name: '成交量',
                            type: 'bar',
                            xAxisIndex: 1,
                            yAxisIndex: 1,
                            data: volumeData,
                            itemStyle: {
                                color: function(params) {
                                    const idx = params.dataIndex;
                                    return data[idx].close >= data[idx].open ? '#ff4d4f' : '#52c41a';
                                }
                            }
                        }
                    ]
                };
                
                chart.setOption(option, true);
                showDebug('K线图绘制完成');
            } catch (error) {
                console.error('绘制K线图失败:', error);
                throw error;
            }
        }

        // 绘制分时图
        function drawLineChart(data) {
            try {
                const times = data.map(d => d.time.split(' ')[1] + '\n' + d.date);
                const prices = data.map(d => d.close);
                const avgPrices = data.map(d => d.avgPrice);
                
                const option = {
                    title: {
                        text: `${currentFileName || '股票'} 分时图 (${document.getElementById('startDate').value} - ${document.getElementById('endDate').value})`,
                        left: 'center',
                        textStyle: { fontSize: 16 }
                    },
                    tooltip: {
                        trigger: 'axis',
                        formatter: function(params) {
                            const dataIndex = params[0].dataIndex;
                            const item = data[dataIndex];
                            return `<div style="font-size: 12px;">
                                <strong>${item.date} ${item.time.split(' ')[1]}</strong><br/>
                                价格: ${item.close.toFixed(2)}<br/>
                                均价: ${item.avgPrice.toFixed(2)}<br/>
                                成交量: ${item.volume.toLocaleString()}
                            </div>`;
                        }
                    },
                    legend: {
                        data: ['收盘价', '均价'],
                        top: 35
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '15%',
                        containLabel: true
                    },
                    dataZoom: [
                        {
                            type: 'inside',
                            start: 0,
                            end: 100
                        },
                        {
                            start: 0,
                            end: 100
                        }
                    ],
                    xAxis: {
                        type: 'category',
                        data: times,
                        axisLabel: { 
                            rotate: 45,
                            interval: Math.max(1, Math.floor(times.length / 15))
                        }
                    },
                    yAxis: {
                        type: 'value',
                        name: '价格',
                        axisLabel: {
                            formatter: '{value}'
                        }
                    },
                    series: [
                        {
                            name: '收盘价',
                            type: 'line',
                            data: prices,
                            smooth: true,
                            lineStyle: {
                                color: '#1890ff',
                                width: 2
                            },
                            itemStyle: {
                                color: '#1890ff'
                            }
                        },
                        {
                            name: '均价',
                            type: 'line',
                            data: avgPrices,
                            smooth: true,
                            lineStyle: {
                                color: '#ff7875',
                                width: 1,
                                type: 'dashed'
                            },
                            itemStyle: {
                                color: '#ff7875'
                            }
                        }
                    ]
                };
                
                chart.setOption(option, true);
                showDebug('分时图绘制完成');
            } catch (error) {
                console.error('绘制分时图失败:', error);
                throw error;
            }
        }

        // 绘制成交量图
        function drawVolumeChart(data) {
            try {
                const times = data.map(d => d.time.split(' ')[1] + '\n' + d.date);
                const volumeData = data.map(d => d.volume);
                
                const option = {
                    title: {
                        text: `${currentFileName || '股票'} 成交量图 (${document.getElementById('startDate').value} - ${document.getElementById('endDate').value})`,
                        left: 'center',
                        textStyle: { fontSize: 16 }
                    },
                    tooltip: {
                        trigger: 'axis',
                        formatter: function(params) {
                            const dataIndex = params[0].dataIndex;
                            const item = data[dataIndex];
                            return `<div style="font-size: 12px;">
                                <strong>${item.date} ${item.time.split(' ')[1]}</strong><br/>
                                成交量: ${item.volume.toLocaleString()}<br/>
                                成交额: ${(item.amount/10000).toFixed(2)}万
                            </div>`;
                        }
                    },
                    legend: {
                        data: ['成交量'],
                        top: 35
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '15%',
                        containLabel: true
                    },
                    dataZoom: [
                        {
                            type: 'inside',
                            start: 0,
                            end: 100
                        },
                        {
                            start: 0,
                            end: 100
                        }
                    ],
                    xAxis: {
                        type: 'category',
                        data: times,
                        axisLabel: { 
                            rotate: 45,
                            interval: Math.max(1, Math.floor(times.length / 15))
                        }
                    },
                    yAxis: {
                        type: 'value',
                        name: '成交量',
                        axisLabel: {
                            formatter: function(value) {
                                if (value >= 10000) {
                                    return (value / 10000).toFixed(1) + '万';
                                }
                                return value.toLocaleString();
                            }
                        }
                    },
                    series: [
                        {
                            name: '成交量',
                            type: 'bar',
                            data: volumeData,
                            itemStyle: {
                                color: function(params) {
                                    const idx = params.dataIndex;
                                    return data[idx].close >= data[idx].open ? '#ff4d4f' : '#52c41a';
                                }
                            }
                        }
                    ]
                };
                
                chart.setOption(option, true);
                showDebug('成交量图绘制完成');
            } catch (error) {
                console.error('绘制成交量图失败:', error);
                throw error;
            }
        }

        // 重置缩放
        function resetZoom() {
            if (chart) {
                chart.dispatchAction({
                    type: 'dataZoom',
                    start: 0,
                    end: 100
                });
                showDebug('缩放已重置');
            }
        }

        // 清空数据
        function clearData() {
            allData = [];
            currentFileName = '';
            document.getElementById('fileInput').value = '';
            document.getElementById('sampleSelect').value = '';
            document.getElementById('updateBtn').disabled = true;
            
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('chart').style.display = 'none';
            document.getElementById('statsPanel').style.display = 'none';
            document.getElementById('debugInfo').style.display = 'none';
            
            if (chart) {
                chart.clear();
            }
        }

        // 页面加载完成后初始化
        window.addEventListener('load', function() {
            console.log('页面加载完成');
            initChart();
            // 默认加载603696示例数据
            loadDataFromUrl('603696_stockzhahistminem _20250823_130857.csv');
        });

        window.addEventListener('resize', function() {
            if (chart) {
                chart.resize();
            }
        });
    </script>
</body>
</html>